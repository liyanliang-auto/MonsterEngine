# MonsterEngine æœ€ç»ˆæ¶æ„è¯´æ˜

**æ—¥æœŸ**: 2025-11-04  
**çŠ¶æ€**: âœ… ç¼–è¯‘é€šè¿‡

---

## âœ… æœ€ç»ˆå†³å®šï¼šä¿ç•™ä¸‰å±‚æ¶æ„ + æ·»åŠ  RHI æŠ½è±¡å±‚

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RHI æŠ½è±¡å±‚ (æ–°å¢)                           â”‚
â”‚  FRHIResource, FRHIBuffer, FRHITexture       â”‚  â† Include/RHI/RHIResources.h
â”‚  TRefCountPtr (æ™ºèƒ½æŒ‡é’ˆ)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ (å¯é€‰ç»§æ‰¿ï¼Œæœªæ¥è·¨å¹³å°æ—¶ä½¿ç”¨)
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vulkan èµ„æºå±‚                               â”‚
â”‚  VulkanBuffer, VulkanTexture                 â”‚  â† VulkanBuffer.h/cpp
â”‚  VulkanDevice, VulkanCommandList             â”‚     VulkanTexture.h/cpp
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å†…å­˜ç®¡ç†å±‚                                  â”‚
â”‚  FVulkanMemoryManager                        â”‚  â† FVulkanMemoryManager.h/cpp
â”‚  + FVulkanMemoryPool (å†…åµŒç±»)               â”‚
â”‚  + FVulkanAllocation                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vulkan API å±‚                               â”‚
â”‚  vkAllocateMemory, vkBindBufferMemory        â”‚
â”‚  vkCreateBuffer, vkCreateImage               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ æ–‡ä»¶åˆ—è¡¨

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| `Include/RHI/RHIResources.h` | RHI æŠ½è±¡å±‚ï¼ˆå¼•ç”¨è®¡æ•°ã€æ™ºèƒ½æŒ‡é’ˆï¼‰ | âœ… å·²æ·»åŠ  |

### ä¿ç•™æ–‡ä»¶ï¼ˆç°æœ‰ç³»ç»Ÿï¼‰

| æ–‡ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| `Include/Platform/Vulkan/FVulkanMemoryManager.h` | å†…å­˜ç®¡ç†å™¨ + å†…å­˜æ± å®šä¹‰ | âœ… ä¿ç•™ |
| `Source/Platform/Vulkan/FVulkanMemoryManager.cpp` | å†…å­˜ç®¡ç†å™¨å®ç° | âœ… ä¿ç•™ |
| `Include/Platform/Vulkan/VulkanBuffer.h` | Vulkan ç¼“å†²åŒº | âœ… ä¿ç•™ |
| `Source/Platform/Vulkan/VulkanBuffer.cpp` | ç¼“å†²åŒºå®ç° | âœ… ä¿ç•™ |
| `Include/Platform/Vulkan/VulkanTexture.h` | Vulkan çº¹ç† | âœ… ä¿ç•™ |
| `Source/Platform/Vulkan/VulkanTexture.cpp` | çº¹ç†å®ç° | âœ… ä¿ç•™ |
| `Include/Platform/Vulkan/VulkanDevice.h` | Vulkan è®¾å¤‡ | âœ… ä¿ç•™ |
| `Source/Platform/Vulkan/VulkanDevice.cpp` | è®¾å¤‡å®ç° | âœ… ä¿ç•™ |

### å·²åˆ é™¤æ–‡ä»¶ï¼ˆå†²çªï¼‰

| æ–‡ä»¶ | åŸå›  | çŠ¶æ€ |
|------|------|------|
| `Include/Platform/Vulkan/FVulkanMemoryPool.h` | ä¸ FVulkanMemoryManager.h ä¸­çš„ç±»é‡å¤ | âŒ å·²åˆ é™¤ |
| `Source/Platform/Vulkan/FVulkanMemoryPool.cpp` | é‡å¤å®ç° | âŒ å·²åˆ é™¤ |
| `Include/Platform/Vulkan/FVulkanResourceManager.h` | ä¸ VulkanBuffer/Texture å†²çª | âŒ å·²åˆ é™¤ |
| `Source/Platform/Vulkan/FVulkanResourceManager.cpp` | å†²çªå®ç° | âŒ å·²åˆ é™¤ |
| `Source/Tests/VulkanGPUMemorySystemTest.cpp` | åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œå¯¼è‡´ç¼–è¯‘é”™è¯¯ | âŒ å·²åˆ é™¤ |

---

## ğŸ¯ æ–°å¢çš„ RHI æŠ½è±¡å±‚

### æ ¸å¿ƒç±»

#### 1. `FRHIResource` - èµ„æºåŸºç±»

```cpp
class FRHIResource {
    std::atomic<uint32> RefCount;  // çº¿ç¨‹å®‰å…¨çš„å¼•ç”¨è®¡æ•°
    bool bCommitted;                // æ˜¯å¦å·²æäº¤åˆ° GPU
    String DebugName;               // è°ƒè¯•åç§°
    
public:
    uint32 AddRef() const;
    uint32 Release() const;
    uint32 GetRefCount() const;
};
```

**ç‰¹æ€§**:
- åŸå­æ“ä½œå®ç°çš„çº¿ç¨‹å®‰å…¨å¼•ç”¨è®¡æ•°
- å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶è‡ªåŠ¨ `delete this`
- æ”¯æŒè°ƒè¯•åç§°

#### 2. `TRefCountPtr<T>` - æ™ºèƒ½æŒ‡é’ˆ

```cpp
template<typename T>
class TRefCountPtr {
    T* Pointer;
    
public:
    TRefCountPtr(T* InPointer);
    ~TRefCountPtr();  // è‡ªåŠ¨è°ƒç”¨ Release()
    
    // æ‹·è´/ç§»åŠ¨è¯­ä¹‰
    TRefCountPtr(const TRefCountPtr& Other);
    TRefCountPtr(TRefCountPtr&& Other) noexcept;
};
```

**ç‰¹æ€§**:
- è‡ªåŠ¨ç®¡ç† AddRef/Release
- æ”¯æŒæ‹·è´å’Œç§»åŠ¨è¯­ä¹‰
- RAII è‡ªåŠ¨é‡Šæ”¾

#### 3. `FRHIBuffer` - ç¼“å†²åŒºæŠ½è±¡

```cpp
class FRHIBuffer : public FRHIResource {
protected:
    uint32 Size;
    EResourceUsage Usage;
    uint32 Stride;
    
public:
    virtual void* Lock(uint32 Offset, uint32 Size) = 0;
    virtual void Unlock() = 0;
    virtual uint64 GetGPUVirtualAddress() const { return 0; }
};
```

#### 4. `FRHITexture` - çº¹ç†æŠ½è±¡

```cpp
class FRHITexture : public FRHIResource {
protected:
    TextureDesc Desc;
    
public:
    uint32 GetWidth() const;
    uint32 GetHeight() const;
    uint32 GetMipLevels() const;
    EPixelFormat GetFormat() const;
};
```

### ä½¿ç”¨ç¤ºä¾‹

```cpp
// ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†èµ„æº
FRHIBufferRef buffer = CreateBuffer(...);
// buffer ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾ï¼Œæ— éœ€æ‰‹åŠ¨ delete

// å¼•ç”¨è®¡æ•°
FRHIBufferRef buffer2 = buffer;  // RefCount = 2
buffer.SafeRelease();            // RefCount = 1
// buffer2 ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼ŒRefCount = 0ï¼Œè‡ªåŠ¨é”€æ¯
```

---

## ğŸ’¡ æœªæ¥æ‰©å±•ï¼ˆå¯é€‰ï¼‰

### æ–¹æ¡ˆ A: è®©ç°æœ‰ç±»ç»§æ‰¿ RHI æ¥å£

```cpp
// VulkanBuffer.h
class VulkanBuffer : public FRHIBuffer {
    // ç°æœ‰å®ç°ä¿æŒä¸å˜
    // ä»…æ·»åŠ ç»§æ‰¿å…³ç³»
};
```

**ä¼˜ç‚¹**:
- æœ€å°ä¿®æ”¹
- ç«‹å³è·å¾—å¼•ç”¨è®¡æ•°å’Œæ™ºèƒ½æŒ‡é’ˆæ”¯æŒ

### æ–¹æ¡ˆ B: è·¨å¹³å°æ”¯æŒï¼ˆæœªæ¥ï¼‰

```cpp
// D3D12Buffer.h
class D3D12Buffer : public FRHIBuffer {
    ID3D12Resource* Resource;
    // D3D12 å®ç°
};

// MetalBuffer.h
class MetalBuffer : public FRHIBuffer {
    id<MTLBuffer> Buffer;
    // Metal å®ç°
};
```

---

## ğŸ“Š å½“å‰ç³»ç»Ÿç‰¹æ€§

### FVulkanMemoryManager

**ç®—æ³•**: Binned2 + å†…å­˜æ± ï¼ˆå‚è€ƒ UE5ï¼‰

**ç‰¹æ€§**:
- âœ… å°å¯¹è±¡å¿«é€Ÿåˆ†é…ï¼ˆ< 16MBï¼‰
- âœ… å¤§å¯¹è±¡ç‹¬ç«‹åˆ†é…ï¼ˆ>= 16MBï¼‰
- âœ… å†…å­˜æ± ï¼ˆé»˜è®¤ 64MB Pagesï¼‰
- âœ… Free-List ç®¡ç†
- âœ… çº¿ç¨‹å®‰å…¨ï¼ˆæ¯ç±»å‹ç‹¬ç«‹ Mutexï¼‰
- âœ… æŒä¹…æ˜ å°„ä¼˜åŒ–
- âœ… ç¢ç‰‡æ•´ç†
- âœ… è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯

### FVulkanMemoryPoolï¼ˆå†…åµŒç±»ï¼‰

**ç®—æ³•**: Free-List

**ç‰¹æ€§**:
- âœ… First-Fit æŸ¥æ‰¾
- âœ… ç›¸é‚»å—åˆå¹¶
- âœ… åŸå­æ“ä½œè¿½è¸ªä½¿ç”¨é‡
- âœ… æŒä¹…æ˜ å°„æ”¯æŒ

---

## ğŸ”§ ç¼–è¯‘çŠ¶æ€

```bash
# ç¼–è¯‘çŠ¶æ€
âœ… æ— ç¼–è¯‘é”™è¯¯
âœ… æ—  Linter è­¦å‘Š
âœ… æ— å¾ªç¯ä¾èµ–
âœ… æ— é‡å¤å®šä¹‰
```

### å…³é”®ä¿®å¤

1. âœ… åˆ é™¤é‡å¤çš„ `FVulkanMemoryPool` å®šä¹‰
2. âœ… åˆ é™¤å†²çªçš„ `FVulkanResourceManager`
3. âœ… æ¢å¤ `FVulkanMemoryManager.h` ä¸­çš„ `FVulkanMemoryPool` å®šä¹‰
4. âœ… ç§»é™¤ `main.cpp` ä¸­å¯¹å·²åˆ é™¤æµ‹è¯•çš„å¼•ç”¨
5. âœ… æ·»åŠ  RHI æŠ½è±¡å±‚ï¼ˆæ— å†²çªï¼‰

---

## ğŸ“ æ€»ç»“

### åšå‡ºçš„å†³ç­–

1. **ä¿ç•™ç°æœ‰ä¸‰å±‚æ¶æ„**  
   FVulkanMemoryManager å·²å®ç° UE5 æ ¸å¿ƒç®—æ³•ï¼Œæ— éœ€é‡å¤å¼€å‘

2. **æ·»åŠ  RHI æŠ½è±¡å±‚**  
   ä¸ºæœªæ¥è·¨å¹³å°æä¾›åŸºç¡€ï¼Œä½†ä¸å¼ºåˆ¶ç°æœ‰ä»£ç ä½¿ç”¨

3. **åˆ é™¤å†²çªæ–‡ä»¶**  
   é¿å…é‡å¤å®šä¹‰å’Œå¾ªç¯ä¾èµ–

### ä¼˜ç‚¹

- âœ… ç³»ç»Ÿç®€æ´ï¼Œæ˜“äºç»´æŠ¤
- âœ… æ— é‡å¤ä»£ç 
- âœ… ç¼–è¯‘é€šè¿‡ï¼Œæ— è­¦å‘Š
- âœ… ä¿ç•™æ‰©å±•æ€§ï¼ˆRHI æŠ½è±¡å±‚ï¼‰
- âœ… ä¸å½±å“ç°æœ‰åŠŸèƒ½

### ä¸‹ä¸€æ­¥

**çŸ­æœŸï¼ˆä¿æŒç°çŠ¶ï¼‰**:
- åŸºäºç°æœ‰æ¶æ„ç»§ç»­å¼€å‘å…¶ä»–åŠŸèƒ½
- RHI æŠ½è±¡å±‚ä»…ä½œä¸ºå¯é€‰æ¥å£

**é•¿æœŸï¼ˆéœ€è¦æ—¶ï¼‰**:
- è®©ç°æœ‰ç±»ç»§æ‰¿ RHI æ¥å£
- æ·»åŠ  D3D12/Metal æ”¯æŒ

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-11-04  
**çŠ¶æ€**: âœ… ç¨³å®šï¼Œå¯ç¼–è¯‘

