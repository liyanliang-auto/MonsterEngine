# 如何运行内存系统测试

## 概述

MonsterEngine内存系统测试套件已集成到引擎入口，可通过命令行参数触发。

## 运行方式

### 方式1：命令行参数（推荐）

在Visual Studio 2022中：

1. **右键项目** → **属性**
2. 导航到：**配置属性** → **调试**
3. 在**命令参数**中输入：`--test-memory` 或 `-tm`
4. 点击**确定**
5. 按**F5**运行

或者在命令行中：

```bash
# 进入编译输出目录
cd E:\MonsterEngine\x64\Debug

# 运行测试
MonsterEngine.exe --test-memory
```

### 方式2：修改main.cpp强制运行

如果需要每次启动都运行测试，可以修改`main.cpp`：

```cpp
// 在main函数中，添加：
bool runTests = true;  // 强制启用测试模式
```

## 测试内容

测试套件包含10个测试场景：

1. ✅ **初始化和关闭** - 验证内存系统启动
2. ✅ **小对象池** - 测试16B-1024B分配
3. ✅ **帧缓冲池** - 测试临时内存分配
4. ✅ **纹理缓冲池** - 测试大块内存分配
5. ✅ **线程本地缓存** - 验证TLS缓存性能
6. ✅ **大页支持** - 检测和测试Huge Pages
7. ✅ **空页回收** - 验证内存回收机制
8. ✅ **统计信息** - 显示详细内存统计
9. ✅ **并发测试** - 4线程并发压力测试
10. ✅ **边界情况** - 测试异常处理

## 预期输出示例

```
Starting MonsterRender Engine

======================================
  Memory System Test Mode
======================================


=== MemorySystem Test Suite Started ===

[Test 1] Initialization and Shutdown
  ✓ MemorySystem initialized: SUCCESS
  ✓ Huge pages available: YES

[Test 2] Small Object Pool
  ✓ Allocated 16B at 0x...
  ✓ Freed 16B
  ...
  ✓ Allocated 1000 objects
  ✓ Freed all objects

[Test 3] Frame Scratch Pool
  Frame 0:
    ✓ Allocated 28KB, total: 28KB
    ✓ Frame reset, memory reclaimed
  ...

[Test 4] Texture Buffer Pool
  ✓ Allocated 1MB texture
  ✓ Allocated 4MB texture
  ...

[Test 5] Thread-Local Cache
  ✓ Allocations: 100
  ✓ Cache hits: 85
  ✓ Cache misses: 15
  ✓ Hit rate: 85%

[Test 6] Huge Pages Support
  System support: YES
  ✓ Enable huge pages: SUCCESS
  ✓ Huge pages enabled for textures
  ✓ Allocated 64MB texture (should use huge pages)

[Test 7] Empty Page Trimming
  Before trimming:
    Pages: 15
    Empty pages: 7
  After trimming:
    Pages: 12
    Empty pages: 4
  ✓ Trimmed 3 pages

[Test 8] Memory Statistics
  === Small Object Pool ===
    Allocated: 64 KB
    Reserved: 768 KB
    Pages: 12
    ...

[Test 9] Concurrent Allocation Test
  ✓ 4 threads completed
  ✓ Total operations: 400
  ✓ Cache hit rate: 90%
  ✓ Duration: 15.2 ms
  ✓ Ops/sec: 26315789

[Test 10] Edge Cases
  ✓ Zero-size allocation handled
  ✓ Null pointer free handled gracefully
  ✓ Large allocation (10MB) fallback to system malloc
  ✓ 16-byte aligned allocation verified
  ✓ All edge cases passed

=== MemorySystem Test Suite Completed ===


======================================
  Test Mode Completed
======================================

```

## 调试技巧

### 1. Visual Studio断点调试

在`Source/MemorySystemTest.cpp`中设置断点：

```cpp
void testHugePages() {
    // 在这里设置断点
    auto& memSys = MemorySystem::get();
    bool available = memSys.isHugePagesAvailable();
    // 单步调试，查看内存分配过程
}
```

### 2. 查看详细日志

测试中的所有`MR_LOG_*`输出会显示在控制台，包括：

- 分配/释放操作
- 内存地址
- 统计数据
- 错误信息

### 3. 修改测试参数

在`MemorySystemTest.cpp`中可以修改测试参数：

```cpp
// 修改分配次数
const int allocCount = 1000;  // 改为更大的值进行压力测试

// 修改线程数
const int numThreads = 4;  // 改为8或16

// 修改纹理大小
void* largeTexture = memSys.textureAllocate(128 * 1024 * 1024);  // 128MB
```

## 常见问题

### Q1: 提示"Huge pages not available"？

**Windows**:
1. 打开`secpol.msc`（本地安全策略）
2. 导航到：本地策略 → 用户权限分配
3. 找到"锁定内存页"，添加当前用户
4. **重启电脑**

**Linux**:
```bash
# 配置大页池
echo 1024 | sudo tee /proc/sys/vm/nr_hugepages

# 验证
cat /proc/meminfo | grep HugePages_Total
```

### Q2: 测试崩溃或失败？

1. 检查内存是否充足（建议至少4GB可用内存）
2. 在Debug模式下运行，查看详细错误信息
3. 查看输出窗口的日志
4. 检查是否有防病毒软件干扰

### Q3: 如何跳过某个测试？

在`runAllTests()`中注释掉相应的测试：

```cpp
void runAllTests() {
    testInitialization();
    testSmallObjectPool();
    // testFrameScratchPool();  // 跳过此测试
    testTexturePool();
    // ...
}
```

## 性能基准

在典型的开发机上（Intel i7/i9, 16GB RAM），预期性能：

- **小对象分配**：< 10ns (TLS缓存命中)
- **小对象分配**：~30ns (缓存未命中)
- **帧缓冲分配**：< 5ns (无锁bump分配)
- **纹理分配**：~100-500ns (大页)
- **TLS缓存命中率**：85-95%
- **并发吞吐量**：10M+ ops/sec (4线程)

## 下一步

测试通过后，可以：

1. 查看 `devDocument/内存系统v3_实现总结.md` 了解实现细节
2. 查看 `devDocument/引擎的架构和设计.md` 了解完整架构
3. 在实际应用中使用内存管理器：

```cpp
#include "Core/Memory.h"

void myFunction() {
    auto& mem = MemorySystem::get();
    
    // 小对象分配
    void* obj = mem.allocateSmall(256);
    // ... use ...
    mem.freeSmall(obj, 256);
    
    // 帧临时数据
    void* temp = mem.frameAllocate(4096);
    // 帧末自动重置
    
    // 纹理/大块数据
    void* tex = mem.textureAllocate(16 * 1024 * 1024);
    // ... use ...
    mem.textureFree(tex);
}
```

---

**祝测试顺利！** 🎉

