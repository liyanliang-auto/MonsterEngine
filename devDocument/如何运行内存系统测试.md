# 如何运行内存系统测试

## 🚀 快速开始（3步）

### 步骤1：确保编译成功

在Visual Studio中：
```
生成 → 重新生成解决方案
```

应该看到：
```
========== 生成: 1 成功，0 失败，0 最新，0 已跳过 ==========
```

---

### 步骤2：设置命令行参数

1. 右键项目 `MonsterEngine` → **属性**
2. 选择 **调试** → **命令参数**
3. 输入：`--test-memory` 或 `-tm`
4. 点击 **确定**

![设置命令行参数](https://i.imgur.com/placeholder.png)

---

### 步骤3：运行测试

按 **F5** 或点击 **本地Windows调试器**

---

## 📊 测试结果说明

### 成功的测试输出示例

```
======================================
  Memory System Test Mode
======================================

=== MemorySystem Test Suite Started ===

[Test 1] Initialization and Shutdown
  [OK] MemorySystem initialized: SUCCESS
  [OK] Huge pages available: YES

[Test 2] Small Object Pool
  [OK] Allocated 16B at 0x000001A2B3C4D5E0
  [OK] Freed 16B
  ...

=== MemorySystem Test Suite Completed ===
```

### 关键指标

| 指标 | 含义 | 预期值 |
|------|------|--------|
| **Cache hit rate** | TLS缓存命中率 | >80% |
| **Ops/sec** | 每秒操作数 | >10,000 |
| **Trimmed pages** | 回收的页数 | ≥0 |
| **Utilization** | 内存利用率 | 70-90% |

---

## 💡 常见问题

### Q1: 显示"Huge pages not available"

**原因**：系统未配置大页支持

**Windows解决方案**：
1. 以管理员运行 `secpol.msc`
2. 本地策略 → 用户权限分配 → 锁定内存页
3. 添加当前用户
4. 重启电脑

**Linux解决方案**：
```bash
# 配置大页
echo 1024 | sudo tee /proc/sys/vm/nr_hugepages
```

---

### Q2: Cache hit rate很低（<50%）

**可能原因**：
- 第一次运行（缓存为空）
- 分配大小不规律

**解决方案**：
- 重复运行几次测试
- 检查`testThreadLocalCache()`结果

---

### Q3: 测试运行很慢

**可能原因**：
- Debug配置性能较低
- 大页分配失败回退到标准页

**建议**：
- 使用Release配置重新编译
- 确保大页支持已启用

---

## 🔍 高级用法

### 单独运行某个测试

编辑`Source/MemorySystemTest.cpp`的`runAllTests()`：

```cpp
void runAllTests() {
    // testInitialization();
    testSmallObjectPool();  // 只运行这个
    // testFrameScratchPool();
    // ...
}
```

### 修改测试参数

例如增加并发线程数：

```cpp
void testConcurrency() {
    const int numThreads = 8;  // 原来是4，改为8
    const int allocsPerThread = 200;  // 原来是100，改为200
    // ...
}
```

### 添加自定义测试

在匿名命名空间中添加新函数：

```cpp
namespace {
    // ...existing tests...
    
    void testMyCustomTest() {
        MR_LOG_INFO("\n[Test Custom] My Custom Test");
        auto& memSys = MemorySystem::get();
        
        // Your test code here
        void* ptr = memSys.allocateSmall(256);
        MR_LOG_INFO("  [OK] My test passed!");
        memSys.freeSmall(ptr, 256);
    }
}

void runAllTests() {
    // ...existing tests...
    testMyCustomTest();  // 添加到这里
}
```

---

## 📈 性能调优建议

### 1. 启用Release优化

项目属性 → C/C++ → 优化 → **完全优化 (/Ox)**

### 2. 调整内存池大小

在`main.cpp`中：

```cpp
MemorySystem::get().initialize(
    16 * 1024 * 1024,   // Frame Scratch: 8MB → 16MB
    128 * 1024 * 1024   // Texture Pool: 64MB → 128MB
);
```

### 3. 启用大页

测试前确保：
```cpp
auto& memSys = MemorySystem::get();
if (memSys.isHugePagesAvailable()) {
    memSys.enableHugePages(true);
    memSys.setHugePagesForTextures(true);
}
```

---

## 🐛 调试技巧

### 在特定测试设置断点

```cpp
void testSmallObjectPool() {
    MR_LOG_INFO("\n[Test 2] Small Object Pool");
    
    // 在这里设置断点 ⬇️
    auto& memSys = MemorySystem::get();
    // ...
}
```

### 查看详细日志

```cpp
// 在main.cpp中启用Debug日志
Logger::getInstance().setMinLevel(ELogLevel::Debug);
```

### 内存泄漏检测（Visual Studio）

项目属性 → C/C++ → 代码生成 → **启用C++异常** → **是 (/EHsc)**

---

## ✅ 检查清单

运行测试前确认：

- [ ] 项目编译成功（0错误，0警告最佳）
- [ ] 设置了命令行参数 `--test-memory`
- [ ] 配置为Debug或Release
- [ ] （可选）大页已启用
- [ ] （可选）日志级别设置正确

---

*最后更新: 2025-10-28*  
*MonsterEngine v0.5.0*
