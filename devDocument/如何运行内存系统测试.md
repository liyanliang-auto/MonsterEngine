# å¦‚ä½•è¿è¡Œå†…å­˜ç³»ç»Ÿæµ‹è¯•

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥ï¼‰

### æ­¥éª¤1ï¼šç¡®ä¿ç¼–è¯‘æˆåŠŸ

åœ¨Visual Studioä¸­ï¼š
```
ç”Ÿæˆ â†’ é‡æ–°ç”Ÿæˆè§£å†³æ–¹æ¡ˆ
```

åº”è¯¥çœ‹åˆ°ï¼š
```
========== ç”Ÿæˆ: 1 æˆåŠŸï¼Œ0 å¤±è´¥ï¼Œ0 æœ€æ–°ï¼Œ0 å·²è·³è¿‡ ==========
```

---

### æ­¥éª¤2ï¼šè®¾ç½®å‘½ä»¤è¡Œå‚æ•°

1. å³é”®é¡¹ç›® `MonsterEngine` â†’ **å±æ€§**
2. é€‰æ‹© **è°ƒè¯•** â†’ **å‘½ä»¤å‚æ•°**
3. è¾“å…¥ï¼š`--test-memory` æˆ– `-tm`
4. ç‚¹å‡» **ç¡®å®š**

![è®¾ç½®å‘½ä»¤è¡Œå‚æ•°](https://i.imgur.com/placeholder.png)

---

### æ­¥éª¤3ï¼šè¿è¡Œæµ‹è¯•

æŒ‰ **F5** æˆ–ç‚¹å‡» **æœ¬åœ°Windowsè°ƒè¯•å™¨**

---

## ğŸ“Š æµ‹è¯•ç»“æœè¯´æ˜

### æˆåŠŸçš„æµ‹è¯•è¾“å‡ºç¤ºä¾‹

```
======================================
  Memory System Test Mode
======================================

=== MemorySystem Test Suite Started ===

[Test 1] Initialization and Shutdown
  [OK] MemorySystem initialized: SUCCESS
  [OK] Huge pages available: YES

[Test 2] Small Object Pool
  [OK] Allocated 16B at 0x000001A2B3C4D5E0
  [OK] Freed 16B
  ...

=== MemorySystem Test Suite Completed ===
```

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | å«ä¹‰ | é¢„æœŸå€¼ |
|------|------|--------|
| **Cache hit rate** | TLSç¼“å­˜å‘½ä¸­ç‡ | >80% |
| **Ops/sec** | æ¯ç§’æ“ä½œæ•° | >10,000 |
| **Trimmed pages** | å›æ”¶çš„é¡µæ•° | â‰¥0 |
| **Utilization** | å†…å­˜åˆ©ç”¨ç‡ | 70-90% |

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: æ˜¾ç¤º"Huge pages not available"

**åŸå› **ï¼šç³»ç»Ÿæœªé…ç½®å¤§é¡µæ”¯æŒ

**Windowsè§£å†³æ–¹æ¡ˆ**ï¼š
1. ä»¥ç®¡ç†å‘˜è¿è¡Œ `secpol.msc`
2. æœ¬åœ°ç­–ç•¥ â†’ ç”¨æˆ·æƒé™åˆ†é… â†’ é”å®šå†…å­˜é¡µ
3. æ·»åŠ å½“å‰ç”¨æˆ·
4. é‡å¯ç”µè„‘

**Linuxè§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# é…ç½®å¤§é¡µ
echo 1024 | sudo tee /proc/sys/vm/nr_hugepages
```

---

### Q2: Cache hit rateå¾ˆä½ï¼ˆ<50%ï¼‰

**å¯èƒ½åŸå› **ï¼š
- ç¬¬ä¸€æ¬¡è¿è¡Œï¼ˆç¼“å­˜ä¸ºç©ºï¼‰
- åˆ†é…å¤§å°ä¸è§„å¾‹

**è§£å†³æ–¹æ¡ˆ**ï¼š
- é‡å¤è¿è¡Œå‡ æ¬¡æµ‹è¯•
- æ£€æŸ¥`testThreadLocalCache()`ç»“æœ

---

### Q3: æµ‹è¯•è¿è¡Œå¾ˆæ…¢

**å¯èƒ½åŸå› **ï¼š
- Debugé…ç½®æ€§èƒ½è¾ƒä½
- å¤§é¡µåˆ†é…å¤±è´¥å›é€€åˆ°æ ‡å‡†é¡µ

**å»ºè®®**ï¼š
- ä½¿ç”¨Releaseé…ç½®é‡æ–°ç¼–è¯‘
- ç¡®ä¿å¤§é¡µæ”¯æŒå·²å¯ç”¨

---

## ğŸ” é«˜çº§ç”¨æ³•

### å•ç‹¬è¿è¡ŒæŸä¸ªæµ‹è¯•

ç¼–è¾‘`Source/MemorySystemTest.cpp`çš„`runAllTests()`ï¼š

```cpp
void runAllTests() {
    // testInitialization();
    testSmallObjectPool();  // åªè¿è¡Œè¿™ä¸ª
    // testFrameScratchPool();
    // ...
}
```

### ä¿®æ”¹æµ‹è¯•å‚æ•°

ä¾‹å¦‚å¢åŠ å¹¶å‘çº¿ç¨‹æ•°ï¼š

```cpp
void testConcurrency() {
    const int numThreads = 8;  // åŸæ¥æ˜¯4ï¼Œæ”¹ä¸º8
    const int allocsPerThread = 200;  // åŸæ¥æ˜¯100ï¼Œæ”¹ä¸º200
    // ...
}
```

### æ·»åŠ è‡ªå®šä¹‰æµ‹è¯•

åœ¨åŒ¿åå‘½åç©ºé—´ä¸­æ·»åŠ æ–°å‡½æ•°ï¼š

```cpp
namespace {
    // ...existing tests...
    
    void testMyCustomTest() {
        MR_LOG_INFO("\n[Test Custom] My Custom Test");
        auto& memSys = MemorySystem::get();
        
        // Your test code here
        void* ptr = memSys.allocateSmall(256);
        MR_LOG_INFO("  [OK] My test passed!");
        memSys.freeSmall(ptr, 256);
    }
}

void runAllTests() {
    // ...existing tests...
    testMyCustomTest();  // æ·»åŠ åˆ°è¿™é‡Œ
}
```

---

## ğŸ“ˆ æ€§èƒ½è°ƒä¼˜å»ºè®®

### 1. å¯ç”¨Releaseä¼˜åŒ–

é¡¹ç›®å±æ€§ â†’ C/C++ â†’ ä¼˜åŒ– â†’ **å®Œå…¨ä¼˜åŒ– (/Ox)**

### 2. è°ƒæ•´å†…å­˜æ± å¤§å°

åœ¨`main.cpp`ä¸­ï¼š

```cpp
MemorySystem::get().initialize(
    16 * 1024 * 1024,   // Frame Scratch: 8MB â†’ 16MB
    128 * 1024 * 1024   // Texture Pool: 64MB â†’ 128MB
);
```

### 3. å¯ç”¨å¤§é¡µ

æµ‹è¯•å‰ç¡®ä¿ï¼š
```cpp
auto& memSys = MemorySystem::get();
if (memSys.isHugePagesAvailable()) {
    memSys.enableHugePages(true);
    memSys.setHugePagesForTextures(true);
}
```

---

## ğŸ› è°ƒè¯•æŠ€å·§

### åœ¨ç‰¹å®šæµ‹è¯•è®¾ç½®æ–­ç‚¹

```cpp
void testSmallObjectPool() {
    MR_LOG_INFO("\n[Test 2] Small Object Pool");
    
    // åœ¨è¿™é‡Œè®¾ç½®æ–­ç‚¹ â¬‡ï¸
    auto& memSys = MemorySystem::get();
    // ...
}
```

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```cpp
// åœ¨main.cppä¸­å¯ç”¨Debugæ—¥å¿—
Logger::getInstance().setMinLevel(ELogLevel::Debug);
```

### å†…å­˜æ³„æ¼æ£€æµ‹ï¼ˆVisual Studioï¼‰

é¡¹ç›®å±æ€§ â†’ C/C++ â†’ ä»£ç ç”Ÿæˆ â†’ **å¯ç”¨C++å¼‚å¸¸** â†’ **æ˜¯ (/EHsc)**

---

## âœ… æ£€æŸ¥æ¸…å•

è¿è¡Œæµ‹è¯•å‰ç¡®è®¤ï¼š

- [ ] é¡¹ç›®ç¼–è¯‘æˆåŠŸï¼ˆ0é”™è¯¯ï¼Œ0è­¦å‘Šæœ€ä½³ï¼‰
- [ ] è®¾ç½®äº†å‘½ä»¤è¡Œå‚æ•° `--test-memory`
- [ ] é…ç½®ä¸ºDebugæˆ–Release
- [ ] ï¼ˆå¯é€‰ï¼‰å¤§é¡µå·²å¯ç”¨
- [ ] ï¼ˆå¯é€‰ï¼‰æ—¥å¿—çº§åˆ«è®¾ç½®æ­£ç¡®

---

*æœ€åæ›´æ–°: 2025-10-28*  
*MonsterEngine v0.5.0*
