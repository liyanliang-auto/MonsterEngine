# å¦‚ä½•è¿è¡Œå†…å­˜ç³»ç»Ÿæµ‹è¯•

## æ¦‚è¿°

MonsterEngineå†…å­˜ç³»ç»Ÿæµ‹è¯•å¥—ä»¶å·²é›†æˆåˆ°å¼•æ“å…¥å£ï¼Œå¯é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è§¦å‘ã€‚

## è¿è¡Œæ–¹å¼

### æ–¹å¼1ï¼šå‘½ä»¤è¡Œå‚æ•°ï¼ˆæ¨èï¼‰

åœ¨Visual Studio 2022ä¸­ï¼š

1. **å³é”®é¡¹ç›®** â†’ **å±æ€§**
2. å¯¼èˆªåˆ°ï¼š**é…ç½®å±æ€§** â†’ **è°ƒè¯•**
3. åœ¨**å‘½ä»¤å‚æ•°**ä¸­è¾“å…¥ï¼š`--test-memory` æˆ– `-tm`
4. ç‚¹å‡»**ç¡®å®š**
5. æŒ‰**F5**è¿è¡Œ

æˆ–è€…åœ¨å‘½ä»¤è¡Œä¸­ï¼š

```bash
# è¿›å…¥ç¼–è¯‘è¾“å‡ºç›®å½•
cd E:\MonsterEngine\x64\Debug

# è¿è¡Œæµ‹è¯•
MonsterEngine.exe --test-memory
```

### æ–¹å¼2ï¼šä¿®æ”¹main.cppå¼ºåˆ¶è¿è¡Œ

å¦‚æœéœ€è¦æ¯æ¬¡å¯åŠ¨éƒ½è¿è¡Œæµ‹è¯•ï¼Œå¯ä»¥ä¿®æ”¹`main.cpp`ï¼š

```cpp
// åœ¨mainå‡½æ•°ä¸­ï¼Œæ·»åŠ ï¼š
bool runTests = true;  // å¼ºåˆ¶å¯ç”¨æµ‹è¯•æ¨¡å¼
```

## æµ‹è¯•å†…å®¹

æµ‹è¯•å¥—ä»¶åŒ…å«10ä¸ªæµ‹è¯•åœºæ™¯ï¼š

1. âœ… **åˆå§‹åŒ–å’Œå…³é—­** - éªŒè¯å†…å­˜ç³»ç»Ÿå¯åŠ¨
2. âœ… **å°å¯¹è±¡æ± ** - æµ‹è¯•16B-1024Båˆ†é…
3. âœ… **å¸§ç¼“å†²æ± ** - æµ‹è¯•ä¸´æ—¶å†…å­˜åˆ†é…
4. âœ… **çº¹ç†ç¼“å†²æ± ** - æµ‹è¯•å¤§å—å†…å­˜åˆ†é…
5. âœ… **çº¿ç¨‹æœ¬åœ°ç¼“å­˜** - éªŒè¯TLSç¼“å­˜æ€§èƒ½
6. âœ… **å¤§é¡µæ”¯æŒ** - æ£€æµ‹å’Œæµ‹è¯•Huge Pages
7. âœ… **ç©ºé¡µå›æ”¶** - éªŒè¯å†…å­˜å›æ”¶æœºåˆ¶
8. âœ… **ç»Ÿè®¡ä¿¡æ¯** - æ˜¾ç¤ºè¯¦ç»†å†…å­˜ç»Ÿè®¡
9. âœ… **å¹¶å‘æµ‹è¯•** - 4çº¿ç¨‹å¹¶å‘å‹åŠ›æµ‹è¯•
10. âœ… **è¾¹ç•Œæƒ…å†µ** - æµ‹è¯•å¼‚å¸¸å¤„ç†

## é¢„æœŸè¾“å‡ºç¤ºä¾‹

```
Starting MonsterRender Engine

======================================
  Memory System Test Mode
======================================


=== MemorySystem Test Suite Started ===

[Test 1] Initialization and Shutdown
  âœ“ MemorySystem initialized: SUCCESS
  âœ“ Huge pages available: YES

[Test 2] Small Object Pool
  âœ“ Allocated 16B at 0x...
  âœ“ Freed 16B
  ...
  âœ“ Allocated 1000 objects
  âœ“ Freed all objects

[Test 3] Frame Scratch Pool
  Frame 0:
    âœ“ Allocated 28KB, total: 28KB
    âœ“ Frame reset, memory reclaimed
  ...

[Test 4] Texture Buffer Pool
  âœ“ Allocated 1MB texture
  âœ“ Allocated 4MB texture
  ...

[Test 5] Thread-Local Cache
  âœ“ Allocations: 100
  âœ“ Cache hits: 85
  âœ“ Cache misses: 15
  âœ“ Hit rate: 85%

[Test 6] Huge Pages Support
  System support: YES
  âœ“ Enable huge pages: SUCCESS
  âœ“ Huge pages enabled for textures
  âœ“ Allocated 64MB texture (should use huge pages)

[Test 7] Empty Page Trimming
  Before trimming:
    Pages: 15
    Empty pages: 7
  After trimming:
    Pages: 12
    Empty pages: 4
  âœ“ Trimmed 3 pages

[Test 8] Memory Statistics
  === Small Object Pool ===
    Allocated: 64 KB
    Reserved: 768 KB
    Pages: 12
    ...

[Test 9] Concurrent Allocation Test
  âœ“ 4 threads completed
  âœ“ Total operations: 400
  âœ“ Cache hit rate: 90%
  âœ“ Duration: 15.2 ms
  âœ“ Ops/sec: 26315789

[Test 10] Edge Cases
  âœ“ Zero-size allocation handled
  âœ“ Null pointer free handled gracefully
  âœ“ Large allocation (10MB) fallback to system malloc
  âœ“ 16-byte aligned allocation verified
  âœ“ All edge cases passed

=== MemorySystem Test Suite Completed ===


======================================
  Test Mode Completed
======================================

```

## è°ƒè¯•æŠ€å·§

### 1. Visual Studioæ–­ç‚¹è°ƒè¯•

åœ¨`Source/MemorySystemTest.cpp`ä¸­è®¾ç½®æ–­ç‚¹ï¼š

```cpp
void testHugePages() {
    // åœ¨è¿™é‡Œè®¾ç½®æ–­ç‚¹
    auto& memSys = MemorySystem::get();
    bool available = memSys.isHugePagesAvailable();
    // å•æ­¥è°ƒè¯•ï¼ŒæŸ¥çœ‹å†…å­˜åˆ†é…è¿‡ç¨‹
}
```

### 2. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

æµ‹è¯•ä¸­çš„æ‰€æœ‰`MR_LOG_*`è¾“å‡ºä¼šæ˜¾ç¤ºåœ¨æ§åˆ¶å°ï¼ŒåŒ…æ‹¬ï¼š

- åˆ†é…/é‡Šæ”¾æ“ä½œ
- å†…å­˜åœ°å€
- ç»Ÿè®¡æ•°æ®
- é”™è¯¯ä¿¡æ¯

### 3. ä¿®æ”¹æµ‹è¯•å‚æ•°

åœ¨`MemorySystemTest.cpp`ä¸­å¯ä»¥ä¿®æ”¹æµ‹è¯•å‚æ•°ï¼š

```cpp
// ä¿®æ”¹åˆ†é…æ¬¡æ•°
const int allocCount = 1000;  // æ”¹ä¸ºæ›´å¤§çš„å€¼è¿›è¡Œå‹åŠ›æµ‹è¯•

// ä¿®æ”¹çº¿ç¨‹æ•°
const int numThreads = 4;  // æ”¹ä¸º8æˆ–16

// ä¿®æ”¹çº¹ç†å¤§å°
void* largeTexture = memSys.textureAllocate(128 * 1024 * 1024);  // 128MB
```

## å¸¸è§é—®é¢˜

### Q1: æç¤º"Huge pages not available"ï¼Ÿ

**Windows**:
1. æ‰“å¼€`secpol.msc`ï¼ˆæœ¬åœ°å®‰å…¨ç­–ç•¥ï¼‰
2. å¯¼èˆªåˆ°ï¼šæœ¬åœ°ç­–ç•¥ â†’ ç”¨æˆ·æƒé™åˆ†é…
3. æ‰¾åˆ°"é”å®šå†…å­˜é¡µ"ï¼Œæ·»åŠ å½“å‰ç”¨æˆ·
4. **é‡å¯ç”µè„‘**

**Linux**:
```bash
# é…ç½®å¤§é¡µæ± 
echo 1024 | sudo tee /proc/sys/vm/nr_hugepages

# éªŒè¯
cat /proc/meminfo | grep HugePages_Total
```

### Q2: æµ‹è¯•å´©æºƒæˆ–å¤±è´¥ï¼Ÿ

1. æ£€æŸ¥å†…å­˜æ˜¯å¦å……è¶³ï¼ˆå»ºè®®è‡³å°‘4GBå¯ç”¨å†…å­˜ï¼‰
2. åœ¨Debugæ¨¡å¼ä¸‹è¿è¡Œï¼ŒæŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
3. æŸ¥çœ‹è¾“å‡ºçª—å£çš„æ—¥å¿—
4. æ£€æŸ¥æ˜¯å¦æœ‰é˜²ç—…æ¯’è½¯ä»¶å¹²æ‰°

### Q3: å¦‚ä½•è·³è¿‡æŸä¸ªæµ‹è¯•ï¼Ÿ

åœ¨`runAllTests()`ä¸­æ³¨é‡Šæ‰ç›¸åº”çš„æµ‹è¯•ï¼š

```cpp
void runAllTests() {
    testInitialization();
    testSmallObjectPool();
    // testFrameScratchPool();  // è·³è¿‡æ­¤æµ‹è¯•
    testTexturePool();
    // ...
}
```

## æ€§èƒ½åŸºå‡†

åœ¨å…¸å‹çš„å¼€å‘æœºä¸Šï¼ˆIntel i7/i9, 16GB RAMï¼‰ï¼Œé¢„æœŸæ€§èƒ½ï¼š

- **å°å¯¹è±¡åˆ†é…**ï¼š< 10ns (TLSç¼“å­˜å‘½ä¸­)
- **å°å¯¹è±¡åˆ†é…**ï¼š~30ns (ç¼“å­˜æœªå‘½ä¸­)
- **å¸§ç¼“å†²åˆ†é…**ï¼š< 5ns (æ— é”bumpåˆ†é…)
- **çº¹ç†åˆ†é…**ï¼š~100-500ns (å¤§é¡µ)
- **TLSç¼“å­˜å‘½ä¸­ç‡**ï¼š85-95%
- **å¹¶å‘ååé‡**ï¼š10M+ ops/sec (4çº¿ç¨‹)

## ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡åï¼Œå¯ä»¥ï¼š

1. æŸ¥çœ‹ `devDocument/å†…å­˜ç³»ç»Ÿv3_å®ç°æ€»ç»“.md` äº†è§£å®ç°ç»†èŠ‚
2. æŸ¥çœ‹ `devDocument/å¼•æ“çš„æ¶æ„å’Œè®¾è®¡.md` äº†è§£å®Œæ•´æ¶æ„
3. åœ¨å®é™…åº”ç”¨ä¸­ä½¿ç”¨å†…å­˜ç®¡ç†å™¨ï¼š

```cpp
#include "Core/Memory.h"

void myFunction() {
    auto& mem = MemorySystem::get();
    
    // å°å¯¹è±¡åˆ†é…
    void* obj = mem.allocateSmall(256);
    // ... use ...
    mem.freeSmall(obj, 256);
    
    // å¸§ä¸´æ—¶æ•°æ®
    void* temp = mem.frameAllocate(4096);
    // å¸§æœ«è‡ªåŠ¨é‡ç½®
    
    // çº¹ç†/å¤§å—æ•°æ®
    void* tex = mem.textureAllocate(16 * 1024 * 1024);
    // ... use ...
    mem.textureFree(tex);
}
```

---

**ç¥æµ‹è¯•é¡ºåˆ©ï¼** ğŸ‰

