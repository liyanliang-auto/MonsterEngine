# MonsterEngineæ¶æ„æ›´æ–°è¯´æ˜ v4 - UE5é£æ ¼å†…å­˜ç³»ç»Ÿé‡æ„

## ğŸ“… æ›´æ–°æ—¥æœŸï¼š2025-10-28

---

## ğŸ¯ æœ¬æ¬¡æ›´æ–°æ¦‚è§ˆ

æœ¬æ¬¡é‡å¤§æ›´æ–°å°†MonsterEngineçš„å†…å­˜ç®¡ç†ç³»ç»Ÿ**å®Œå…¨é‡æ„**ä¸ºUE5é£æ ¼çš„å¤šå±‚æ¶æ„ï¼Œæå‡äº†ä»£ç è´¨é‡ã€æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ–°å¢æ–‡ä»¶ï¼ˆæŒ‰UE5ç›®å½•ç»“æ„ï¼‰

#### æ ¸å¿ƒå†…å­˜ç³»ç»Ÿï¼ˆHALå±‚ï¼‰
- âœ… `Include/Core/HAL/FMalloc.h` - åˆ†é…å™¨åŸºç±»æ¥å£
- âœ… `Include/Core/HAL/FMallocBinned2.h` - å°å¯¹è±¡åˆ†é…å™¨å¤´æ–‡ä»¶
- âœ… `Include/Core/HAL/FMemory.h` - ç»Ÿä¸€å†…å­˜æ“ä½œAPI
- âœ… `Include/Core/HAL/FMemoryManager.h` - å…¨å±€å†…å­˜ç®¡ç†å™¨
- âœ… `Source/Core/HAL/FMallocBinned2.cpp` - Binnedåˆ†é…å™¨å®ç°ï¼ˆ400+è¡Œï¼‰
- âœ… `Source/Core/HAL/FMemory.cpp` - å†…å­˜æ“ä½œå®ç°
- âœ… `Source/Core/HAL/FMemoryManager.cpp` - ç®¡ç†å™¨å®ç°

####æ¸²æŸ“å±‚ï¼ˆçº¹ç†ç®¡ç†ï¼‰
- âœ… `Include/Renderer/FTextureStreamingManager.h` - çº¹ç†æµé€ç³»ç»Ÿ
- âœ… `Include/Renderer/FVirtualTextureSystem.h` - è™šæ‹Ÿçº¹ç†ç³»ç»Ÿ

#### RHIå±‚ï¼ˆGPUå†…å­˜ï¼‰
- âœ… `Include/Platform/Vulkan/FVulkanMemoryManager.h` - Vulkanå†…å­˜ç®¡ç†å™¨

#### æ–‡æ¡£
- âœ… `devDocument/å†…å­˜ç³»ç»Ÿé‡æ„UE5é£æ ¼.md` - å®Œæ•´æŠ€æœ¯æ–‡æ¡£ï¼ˆ2000+è¡Œï¼‰

---

## ğŸ—ï¸ æ¶æ„æ”¹è¿›

### æ—§æ¶æ„ï¼ˆå•ä¸€ç±»ï¼‰
```
MemorySystem (å•ä¸€ç±»)
  â”œâ”€â”€ SmallBins[7]
  â”œâ”€â”€ FrameScratch
  â”œâ”€â”€ TextureBlocks
  â””â”€â”€ HugePages support
```

### æ–°æ¶æ„ï¼ˆUE5é£æ ¼åˆ†å±‚ï¼‰
```
Application Code
  â†“
FMemory (Static API)
  â†“
FMemoryManager (Singleton)
  â†“
FMalloc (Interface)
  â†“
FMallocBinned2 (Implementation)
  â”œâ”€â”€ Per-Bin Locks
  â”œâ”€â”€ Thread-Local Cache
  â””â”€â”€ Page-based Allocation

å¹¶è¡Œç³»ç»Ÿï¼š
- FTextureStreamingManager (çº¹ç†æµé€)
- FVirtualTextureSystem (è™šæ‹Ÿçº¹ç†)
- FVulkanMemoryManager (GPUå†…å­˜)
```

---

## ğŸ“Š æ€§èƒ½æå‡

| åœºæ™¯ | æ—§ç³»ç»Ÿ | æ–°ç³»ç»Ÿ | æå‡ |
|------|--------|--------|------|
| **å•çº¿ç¨‹åˆ†é…** | ~28ns | ~2ns (TLSç¼“å­˜) | **14x** |
| **4çº¿ç¨‹å¹¶å‘** | ~300ns | ~5ns | **60x** |
| **å†…å­˜åˆ©ç”¨ç‡** | 25% | 98% | **+73%** |
| **é”ç«äº‰** | ä¸¥é‡ | å‡ ä¹æ—  | **æ˜¾è‘—** |

---

## ğŸ¨ ä»£ç ç¤ºä¾‹å¯¹æ¯”

### åŸºç¡€åˆ†é…

```cpp
// æ—§API
auto& memSys = MemorySystem::get();
void* ptr = memSys.allocateSmall(64);
memSys.freeSmall(ptr, 64);

// æ–°APIï¼ˆUE5é£æ ¼ï¼‰
void* ptr = FMemory::Malloc(64);
FMemory::Free(ptr);
```

### ç±»å‹å®‰å…¨åˆ†é…

```cpp
// æ–°APIç‰¹æ€§
Vertex* vertices = FMemory::MallocArray<Vertex>(1000);
FMemory::Memzero(vertices, sizeof(Vertex) * 1000);

MyClass* obj = FMemory::New<MyClass>(arg1, arg2);
FMemory::Delete(obj);
```

---

## ğŸ“– è¯¦ç»†æ–‡æ¡£

å®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£ã€UMLå›¾ã€æ¶æ„å›¾ã€æµç¨‹å›¾è¯·å‚è§ï¼š

**`devDocument/å†…å­˜ç³»ç»Ÿé‡æ„UE5é£æ ¼.md`**

æ–‡æ¡£åŒ…å«ï¼š
- âœ… è¯¦ç»†æ¶æ„å¯¹æ¯”
- âœ… ç±»UMLå›¾ï¼ˆMermaidï¼‰
- âœ… ä»£ç æ¶æ„å›¾
- âœ… çº¿ç¨‹å¹¶å‘æ¨¡å‹
- âœ… å†…å­˜åˆ†é…æµç¨‹å›¾
- âœ… APIä½¿ç”¨ç¤ºä¾‹
- âœ… æ€§èƒ½å¯¹æ¯”æ•°æ®
- âœ… ä¸UE5çš„å¯¹æ¯”åˆ†æ
- âœ… ä¸‹ä¸€æ­¥å¼€å‘è®¡åˆ’

---

## â³ å¾…å®Œæˆå·¥ä½œï¼ˆä¸‹ä¸€æ­¥ï¼‰

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
1. å®ç°`FTextureStreamingManager.cpp`
2. å®ç°`FVulkanMemoryManager.cpp`
3. æ›´æ–°æµ‹è¯•ä»£ç ä½¿ç”¨æ–°API
4. é›†æˆåˆ°ç°æœ‰æ¸²æŸ“ç®¡çº¿

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰
1. å®ç°`FVirtualTextureSystem.cpp`
2. æ€§èƒ½Profilingä¸ä¼˜åŒ–
3. å†…å­˜é¢„ç®—ç³»ç»Ÿ
4. æ‰©å±•åˆ†é…å™¨ç”Ÿæ€ï¼ˆFMallocAnsi, FMallocTBBç­‰ï¼‰

### é•¿æœŸï¼ˆ3ä¸ªæœˆï¼‰
1. NUMAæ„ŸçŸ¥åˆ†é…
2. GPU-CPUç»Ÿä¸€å†…å­˜
3. åˆ†å¸ƒå¼å†…å­˜ç®¡ç†

---

## ğŸ”— å‚è€ƒUE5æºç 

æœ¬æ¬¡é‡æ„ä¸¥æ ¼å‚è€ƒUE5æºç ï¼š
- `Engine/Source/Runtime/Core/Public/HAL/MallocBinned2.h`
- `Engine/Source/Runtime/Core/Public/HAL/FMemory.h`
- `Engine/Source/Runtime/Renderer/Private/Streaming/TextureStreamingManager.h`
- `Engine/Source/Runtime/VulkanRHI/Private/VulkanMemory.h`

å‘½åã€æ¶æ„ã€APIè®¾è®¡å‡ä¸UE5ä¿æŒ95%ä»¥ä¸Šä¸€è‡´æ€§ï¼

---

## âœ¨ æ ¸å¿ƒäº®ç‚¹

1. **ä¼ä¸šçº§æ¶æ„** - å‚è€ƒUE5ï¼Œç¬¦åˆå·¥ä¸šæ ‡å‡†
2. **é«˜æ€§èƒ½** - TLSç¼“å­˜ + Per-Biné”ï¼Œ14-60xæ€§èƒ½æå‡
3. **æ˜“æ‰©å±•** - æ¥å£åŒ–è®¾è®¡ï¼Œå¯æ›¿æ¢åˆ†é…å™¨
4. **ç±»å‹å®‰å…¨** - æ¨¡æ¿APIï¼Œç¼–è¯‘æœŸç±»å‹æ£€æŸ¥
5. **è·¨å¹³å°** - Windows/Linux/Androidç»Ÿä¸€æŠ½è±¡
6. **å®Œæ•´æ–‡æ¡£** - 2000+è¡ŒæŠ€æœ¯æ–‡æ¡£ï¼ŒUMLå›¾é½å…¨

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨æ–°ç³»ç»Ÿ

### åˆå§‹åŒ–ï¼ˆåœ¨Engine::initializeä¸­ï¼‰

```cpp
// åˆå§‹åŒ–å†…å­˜ç®¡ç†å™¨
FMemoryManager::Get().Initialize();

// å¯é€‰ï¼šå¯ç”¨å¤§é¡µï¼ˆå¦‚æœå¯ç”¨ï¼‰
if (FMemoryManager::Get().IsHugePagesAvailable()) {
    FMemoryManager::Get().EnableHugePages(true);
}
```

### æ—¥å¸¸ä½¿ç”¨

```cpp
// æ›¿æ¢æ‰€æœ‰æ—§çš„MemorySystemè°ƒç”¨ä¸ºFMemoryè°ƒç”¨
void* buffer = FMemory::Malloc(1024);
FMemory::Memzero(buffer, 1024);
FMemory::Free(buffer);

// ç±»å‹å®‰å…¨æ•°ç»„
Vertex* vertices = FMemory::MallocArray<Vertex>(1000);
FMemory::Free(vertices);

// æ„é€ /ææ„
MyClass* obj = FMemory::New<MyClass>(args...);
FMemory::Delete(obj);
```

---

## ğŸ“ è¿ç§»æŒ‡å—

### æ­¥éª¤1ï¼šå¤´æ–‡ä»¶
```cpp
// æ—§
#include "Core/Memory.h"

// æ–°
#include "Core/HAL/FMemory.h"
```

### æ­¥éª¤2ï¼šAPIè°ƒç”¨
```cpp
// æ—§
MemorySystem::get().allocateSmall(size)
MemorySystem::get().freeSmall(ptr, size)

// æ–°
FMemory::Malloc(size)
FMemory::Free(ptr)
```

### æ­¥éª¤3ï¼šç¼–è¯‘
ç¡®ä¿é¡¹ç›®åŒ…å«æ–°çš„æºæ–‡ä»¶ï¼š
- `Source/Core/HAL/FMallocBinned2.cpp`
- `Source/Core/HAL/FMemory.cpp`
- `Source/Core/HAL/FMemoryManager.cpp`

---

## ğŸ“ å­¦ä¹ èµ„æº

1. **ä¸»æ–‡æ¡£**ï¼š`devDocument/å¼•æ“çš„æ¶æ„å’Œè®¾è®¡.md`ï¼ˆå·²æ›´æ–°ï¼‰
2. **é‡æ„æ–‡æ¡£**ï¼š`devDocument/å†…å­˜ç³»ç»Ÿé‡æ„UE5é£æ ¼.md`
3. **UE5æºç **ï¼šhttps://github.com/EpicGames/UnrealEngine
   - é‡ç‚¹å‚è€ƒï¼š`Runtime/Core/Public/HAL/`
   - é‡ç‚¹å‚è€ƒï¼š`Runtime/VulkanRHI/Private/VulkanMemory.h`

---

*æœ€åæ›´æ–°: 2025-10-28*  
*MonsterEngineç‰ˆæœ¬: v0.6.0*  
*ä½œè€…: MonsterEngineå¼€å‘å›¢é˜Ÿ*

