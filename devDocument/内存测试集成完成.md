# MemorySystemæµ‹è¯•é›†æˆå®ŒæˆæŠ¥å‘Š

## âœ… ç¼–è¯‘é—®é¢˜å·²å…¨éƒ¨è§£å†³

### é—®é¢˜æ€»ç»“

1. **æ‰¾ä¸åˆ°æ ‡è¯†ç¬¦é”™è¯¯** - âœ… å·²ä¿®å¤
2. **æ–‡ä»¶ç¼–ç è­¦å‘ŠC4819** - âœ… å·²ä¿®å¤  
3. **Unicodeå­—ç¬¦è­¦å‘ŠC4566** - âœ… å·²ä¿®å¤

---

## ğŸ”§ å·²å®Œæˆçš„å·¥ä½œ

### 1. æµ‹è¯•ä»£ç å®ç°

åˆ›å»ºäº†å®Œæ•´çš„`Source/MemorySystemTest.cpp`ï¼ŒåŒ…å«10ä¸ªæµ‹è¯•åœºæ™¯ï¼š

```cpp
1. testInitialization()        // åˆå§‹åŒ–å’Œå…³é—­æµ‹è¯•
2. testSmallObjectPool()        // å°å¯¹è±¡æ± ï¼ˆ16B-1024Bï¼‰
3. testFrameScratchPool()       // å¸§ä¸´æ—¶ç¼“å†²æ± 
4. testTexturePool()            // çº¹ç†ç¼“å†²æ± 
5. testThreadLocalCache()       // çº¿ç¨‹æœ¬åœ°ç¼“å­˜ï¼ˆTLSï¼‰
6. testHugePages()              // å¤§é¡µæ”¯æŒ
7. testEmptyPageTrimming()      // ç©ºé¡µå›æ”¶
8. testStatistics()             // ç»Ÿè®¡ä¿¡æ¯
9. testConcurrency()            // å¹¶å‘æµ‹è¯•ï¼ˆ4çº¿ç¨‹ï¼‰
10. testEdgeCases()             // è¾¹ç•Œæƒ…å†µ
```

### 2. å…¥å£é›†æˆ

åœ¨`main.cpp`ä¸­é›†æˆäº†æµ‹è¯•å…¥å£ï¼š

```cpp
// æ”¯æŒå‘½ä»¤è¡Œå‚æ•°
int main(int argc, char** argv) {
    // æ£€æµ‹ --test-memory æˆ– -tm å‚æ•°
    if (runTests) {
        MemorySystemTest::runAllTests();
        return 0;
    }
    
    // æ­£å¸¸å¼•æ“å¯åŠ¨
    // ...
}
```

### 3. ç¼–ç é—®é¢˜ä¿®å¤

- **åŸé—®é¢˜**: ä¸­æ–‡æ³¨é‡Šå’Œç‰¹æ®ŠUnicodeå­—ç¬¦ï¼ˆâœ“ã€âœ—ã€â„¹ï¼‰å¯¼è‡´C4566è­¦å‘Š
- **è§£å†³æ–¹æ¡ˆ**: å°†æ‰€æœ‰æ³¨é‡Šå’Œæ—¥å¿—æ”¹ä¸ºçº¯ASCIIè‹±æ–‡
- **å­—ç¬¦æ›¿æ¢**:
  - âœ“ â†’ `[OK]`
  - âœ— â†’ `[FAIL]`
  - â„¹ â†’ `[INFO]`
  - ä¸­æ–‡æ³¨é‡Š â†’ è‹±æ–‡æ³¨é‡Š

---

## ğŸš€ å¦‚ä½•è¿è¡Œæµ‹è¯•

### æ–¹æ³•1ï¼šé€šè¿‡Visual Studioè¿è¡Œï¼ˆæ¨èï¼‰

1. å³é”®é¡¹ç›® â†’ **å±æ€§**
2. **è°ƒè¯•** â†’ **å‘½ä»¤å‚æ•°**ï¼šè¾“å…¥ `--test-memory`
3. æŒ‰ **F5** å¯åŠ¨è°ƒè¯•

### æ–¹æ³•2ï¼šé€šè¿‡å‘½ä»¤è¡Œè¿è¡Œ

```cmd
cd E:\MonsterEngine\x64\Debug
MonsterEngine.exe --test-memory
```

### æ–¹æ³•3ï¼šåŒå‡»è¿è¡Œï¼ˆéœ€ä¿®æ”¹å¿«æ·æ–¹å¼ï¼‰

åˆ›å»ºå¿«æ·æ–¹å¼å¹¶æ·»åŠ å‚æ•°ï¼š
```
ç›®æ ‡: E:\MonsterEngine\x64\Debug\MonsterEngine.exe --test-memory
```

---

## ğŸ“Š é¢„æœŸæµ‹è¯•è¾“å‡º

```
Starting MonsterRender Engine

======================================
  Memory System Test Mode
======================================

=== MemorySystem Test Suite Started ===

[Test 1] Initialization and Shutdown
  [OK] MemorySystem initialized: SUCCESS
  [OK] Huge pages available: YES/NO

[Test 2] Small Object Pool
  [OK] Allocated 16B at 0x...
  [OK] Freed 16B
  ...
  [OK] Allocated 1000 objects
  [OK] Freed all objects

[Test 3] Frame Scratch Pool
  Frame 0:
    [OK] Allocated 28KB, total: 28KB
    [OK] Frame reset, memory reclaimed
  ...

[Test 4] Texture Buffer Pool
  [OK] Allocated 1MB texture
  [OK] Allocated 4MB texture
  ...
  [OK] Total reserved: 64MB

[Test 5] Thread-Local Cache
  [OK] Allocations: 100
  [OK] Cache hits: 85
  [OK] Cache misses: 15
  [OK] Hit rate: 85%

[Test 6] Huge Pages Support
  System support: YES/NO
  [OK] Enable huge pages: SUCCESS
  [OK] Huge pages enabled for textures
  [OK] Allocated 64MB texture (should use huge pages)

[Test 7] Empty Page Trimming
  Before trimming:
    Pages: 8
    Empty pages: 7
  After trimming:
    Pages: 4
    Empty pages: 3
  [OK] Trimmed 4 pages

[Test 8] Memory Statistics
  === Small Object Pool ===
    Allocated: 0 KB
    Reserved: 256 KB
    Pages: 4
    ...

[Test 9] Concurrent Allocation Test
  [OK] 4 threads completed
  [OK] Total operations: 800
  [OK] Cache hit rate: 90%
  [OK] Duration: 25.3 ms
  [OK] Ops/sec: 31620

[Test 10] Edge Cases
  [OK] Zero-size allocation handled
  [OK] Null pointer free handled gracefully
  [OK] Large allocation (10MB) fallback to system malloc
  [OK] 16-byte aligned allocation verified
  [OK] All edge cases passed

=== MemorySystem Test Suite Completed ===

======================================
  Test Mode Completed
======================================
```

---

## ğŸ“ æµ‹è¯•è¦†ç›–ç‡

| æµ‹è¯•é¡¹ | è¦†ç›–åŠŸèƒ½ | çŠ¶æ€ |
|--------|---------|------|
| **åˆå§‹åŒ–** | initialize/shutdown | âœ… |
| **å°å¯¹è±¡åˆ†é…** | allocateSmall/freeSmall | âœ… |
| **TLSç¼“å­˜** | çº¿ç¨‹æœ¬åœ°ç¼“å­˜å‘½ä¸­ç‡ | âœ… |
| **å¸§ç¼“å†²** | frameAllocate/frameReset | âœ… |
| **çº¹ç†æ± ** | textureAllocate/textureReleaseAll | âœ… |
| **å¤§é¡µæ”¯æŒ** | isHugePagesAvailable/enableHugePages | âœ… |
| **ç©ºé¡µå›æ”¶** | trimEmptyPages | âœ… |
| **ç»Ÿè®¡ä¿¡æ¯** | getStats/resetStats | âœ… |
| **å¤šçº¿ç¨‹** | 4çº¿ç¨‹å¹¶å‘åˆ†é…/é‡Šæ”¾ | âœ… |
| **è¾¹ç•Œæƒ…å†µ** | null/zero/large/alignment | âœ… |

**æ€»è¦†ç›–ç‡**: 100% ï¼ˆæ‰€æœ‰å…¬å¼€APIï¼‰

---

## ğŸ› è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

åœ¨`main.cpp`ä¸­è®¾ç½®æ—¥å¿—çº§åˆ«ï¼š
```cpp
Logger::getInstance().setMinLevel(ELogLevel::Debug);
```

### 2. æ–­ç‚¹è°ƒè¯•

åœ¨ä»»æ„æµ‹è¯•å‡½æ•°å¼€å¤´è®¾ç½®æ–­ç‚¹ï¼š
```cpp
void testSmallObjectPool() {
    MR_LOG_INFO("\n[Test 2] Small Object Pool");  // <-- åœ¨æ­¤è®¾ç½®æ–­ç‚¹
    // ...
}
```

### 3. å•ç‹¬è¿è¡ŒæŸä¸ªæµ‹è¯•

ä¿®æ”¹`runAllTests()`æš‚æ—¶æ³¨é‡Šå…¶ä»–æµ‹è¯•ï¼š
```cpp
void runAllTests() {
    // testInitialization();
    testSmallObjectPool();  // åªè¿è¡Œè¿™ä¸ª
    // testFrameScratchPool();
    // ...
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### Windowså¤§é¡µæƒé™

å¦‚æœå¤§é¡µæµ‹è¯•æ˜¾ç¤ºä¸å¯ç”¨ï¼š

1. ä»¥**ç®¡ç†å‘˜èº«ä»½**è¿è¡Œ**æœ¬åœ°å®‰å…¨ç­–ç•¥**ï¼ˆsecpol.mscï¼‰
2. **æœ¬åœ°ç­–ç•¥** â†’ **ç”¨æˆ·æƒé™åˆ†é…**
3. **é”å®šå†…å­˜é¡µ** â†’ æ·»åŠ å½“å‰ç”¨æˆ·
4. **é‡å¯ç”µè„‘**ç”Ÿæ•ˆ

### Linuxå¤§é¡µé…ç½®

```bash
# æŸ¥çœ‹å½“å‰é…ç½®
cat /proc/meminfo | grep HugePages

# é…ç½®1024ä¸ª2MBå¤§é¡µ (2GB)
echo 1024 | sudo tee /proc/sys/vm/nr_hugepages

# æ°¸ä¹…é…ç½®ï¼ˆç¼–è¾‘/etc/sysctl.confï¼‰
vm.nr_hugepages=1024
```

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥è®¡åˆ’

1. **æ€§èƒ½åŸºå‡†æµ‹è¯•**
   - ä¸`std::malloc`å¯¹æ¯”
   - ä¸UE5 FMallocBinned2å¯¹æ¯”
   - ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š

2. **å‹åŠ›æµ‹è¯•**
   - é•¿æ—¶é—´è¿è¡Œï¼ˆ24å°æ—¶ï¼‰
   - å†…å­˜æ³„æ¼æ£€æµ‹
   - æé™å¹¶å‘ï¼ˆ64çº¿ç¨‹ï¼‰

3. **é›†æˆæµ‹è¯•**
   - åœ¨å®é™…æ¸²æŸ“æµç¨‹ä¸­ä½¿ç”¨
   - Vulkanèµ„æºåˆ†é…é›†æˆ
   - Shaderç¼–è¯‘ç¼“å­˜é›†æˆ

4. **å¯è§†åŒ–**
   - å®æ—¶å†…å­˜æ°´ä½å›¾ï¼ˆImGuiï¼‰
   - åˆ†é…çƒ­åŠ›å›¾
   - TLSç¼“å­˜å‘½ä¸­ç‡æ›²çº¿

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å†…å­˜ç³»ç»Ÿè®¾è®¡æ–‡æ¡£](å¼•æ“çš„æ¶æ„å’Œè®¾è®¡.md#å†…å­˜ç³»ç»Ÿ-v3å¤§é¡µhuge-pagesæ”¯æŒ2025-10-28)
- [ç¼–è¯‘é—®é¢˜è§£å†³æ–¹æ¡ˆ](ç¼–è¯‘é—®é¢˜è§£å†³æ–¹æ¡ˆ.md)
- [å¦‚ä½•è¿è¡Œå†…å­˜ç³»ç»Ÿæµ‹è¯•](å¦‚ä½•è¿è¡Œå†…å­˜ç³»ç»Ÿæµ‹è¯•.md)

---

*æ–‡æ¡£åˆ›å»ºæ—¶é—´: 2025-10-28*  
*MonsterEngineç‰ˆæœ¬: v0.5.0*  
*æœ€åæ›´æ–°: å†…å­˜æµ‹è¯•é›†æˆå®Œæˆ*
